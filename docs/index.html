<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KokoroSystem EX v2.0 - Cognitive-Emotional Architecture Demo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%); margin: 0; padding: 15px; color: #e0e6ed; min-height: 100vh; }
        .dashboard { max-width: 1600px; margin: 0 auto; display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 15px; }
        .panel { background: linear-gradient(135deg, rgba(13,110,253,.1), rgba(108,117,125,.05)); border-radius: 12px; padding: 20px; backdrop-filter: blur(10px); border: 1px solid rgba(108,117,125,.3); position: relative; overflow: hidden; }
        .panel::before { content: ""; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, #0d6efd, #6f42c1, #d63384); }
        .full-width { grid-column: 1 / -1; }
        .header { text-align: center; margin-bottom: 20px; }
        .header h1 { margin: 0 0 10px 0; font-size: 2.2em; background: linear-gradient(45deg, #0d6efd, #6f42c1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .version-info { font-size: .9em; opacity: .7; margin-bottom: 15px; }
        .core-status { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-top: 15px; }
        .status-item { background: linear-gradient(135deg, rgba(13,110,253,.15), rgba(108,117,125,.1)); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid rgba(13,110,253,.2); }
        .value { font-size: 1.8em; font-weight: bold; margin: 8px 0; text-shadow: 0 0 10px rgba(13,110,253,.5); }
        .chart-container { position: relative; height: 280px; margin: 15px 0; }
        .pmc-status { text-align: center; padding: 20px; border-radius: 10px; margin: 15px 0; border: 2px solid; }
        .coherent { background: linear-gradient(135deg, rgba(25,135,84,.2), rgba(25,135,84,.1)); border-color: #198754; color: #75b798; }
        .at-risk { background: linear-gradient(135deg, rgba(255,193,7,.2), rgba(255,193,7,.1)); border-color: #ffc107; color: #ffd966; }
        .violated { background: linear-gradient(135deg, rgba(220,53,69,.2), rgba(220,53,69,.1)); border-color: #dc3545; color: #f5a3a3; }
        .module-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin: 15px 0; }
        .module-item { background: linear-gradient(135deg, rgba(108,117,125,.15), rgba(108,117,125,.05)); padding: 15px; border-radius: 8px; border-left: 4px solid #6f42c1; }
        .active { border-left-color: #198754; } .warning { border-left-color: #ffc107; } .error { border-left-color: #dc3545; }
        .hollow-section { background: linear-gradient(135deg, rgba(108,117,125,.1), rgba(13,110,253,.05)); padding: 20px; border-radius: 10px; margin: 15px 0; border: 1px dashed rgba(108,117,125,.3); text-align: center; }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%{opacity:1} 50%{opacity:.6} 100%{opacity:1} }
        .parameter-table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        .parameter-table th, .parameter-table td { padding: 8px 12px; text-align: left; border-bottom: 1px solid rgba(108,117,125,.3); }
        .parameter-table th { background: rgba(13,110,253,.1); font-weight: 600; }
        .input-section { grid-column: 1 / -1; background: linear-gradient(135deg, rgba(13,110,253,.15), rgba(25,135,84,.1)); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid rgba(13,110,253,.3); }
        .input-section h3 { margin-top: 0; color: #0d6efd; }
        .input-section textarea { width: 100%; height: 120px; padding: 15px; border-radius: 8px; border: 1px solid rgba(108,117,125,.3); background: rgba(255,255,255,.08); color: #e0e6ed; font-size: 1em; resize: vertical; box-sizing: border-box; }
        .input-section textarea::placeholder { color: rgba(224,230,237,.6); }
        .input-section button { margin-top: 15px; padding: 12px 25px; background: linear-gradient(45deg, #0d6efd, #6f42c1); border: none; border-radius: 8px; color: white; cursor: pointer; font-size: 1em; transition: all .3s ease; }
        .input-section button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(13,110,253,.4); }
        .input-section button:disabled { opacity: .6; cursor: not-allowed; transform: none; }
        .log-output { grid-column: 1 / -1; background: linear-gradient(135deg, rgba(0,0,0,.4), rgba(13,110,253,.05)); padding: 20px; border-radius: 12px; white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: .9em; max-height: 500px; overflow-y: auto; margin-top: 20px; border: 1px solid rgba(13,110,253,.2); line-height: 1.4; }
        .processing { border-left: 4px solid #0d6efd; padding-left: 10px; color: #87ceeb; }
        .success { border-left: 4px solid #198754; padding-left: 10px; color: #90ee90; }
        .warning { border-left: 4px solid #ffc107; padding-left: 10px; color: #ffd700; }
        .error { border-left: 4px solid #dc3545; padding-left: 10px; color: #ffb3b3; }
        .real-implementation { background: linear-gradient(135deg, rgba(25,135,84,.2), rgba(13,110,253,.1)); border: 2px solid #198754; padding: 20px; border-radius: 12px; margin: 20px 0; }
        .emotion-analysis { background: rgba(255,255,255,.08); padding: 15px; border-radius: 10px; margin: 10px 0; }
        .emotion-bar { background: rgba(255,255,255,.2); border-radius: 10px; height: 20px; margin: 5px 0; position: relative; overflow: hidden; }
        .emotion-fill { height: 100%; border-radius: 10px; transition: width .8s ease; }
        .consistency { background: linear-gradient(90deg, #ff6b6b, #ee5a24); }
        .layer { background: linear-gradient(90deg, #4ecdc4, #44a08d); }
        .temporal { background: linear-gradient(90deg, #feca57, #ff9ff3); }
        .vector { background: linear-gradient(90deg, #5f27cd, #00d2d3); }
        .reply-box { background: rgba(13,110,253,.08); border-left: 4px solid #0d6efd; padding: 14px; border-radius: 8px; }
        .reply-header { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        .reply-text { margin-top: 10px; line-height: 1.7; }
        .pill { font-size: .85em; padding: 4px 8px; border-radius: 999px; background: rgba(255,255,255,.1); }
        .subtle { opacity: .75; font-size: .9em; }
        .btn-row { display: flex; gap: 10px; margin-top: 10px; }
        .btn-ghost { background: rgba(255,255,255,.08); border: 1px solid rgba(255,255,255,.2); color: #e0e6ed; padding: 8px 12px; border-radius: 8px; cursor: pointer; }
        /* æ–°ã—ã„èª¬æ˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .explanation-panel {
            background: linear-gradient(135deg, rgba(25,135,84,.15), rgba(13,110,253,.1));
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            border: 2px solid rgba(25,135,84,.3);
        }
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }
        .feature-card {
            background: rgba(255,255,255,.08);
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #6f42c1;
            transition: transform 0.3s ease;
        }
        .feature-card:hover {
            transform: translateY(-5px);
            background: rgba(255,255,255,.12);
        }
        .feature-card h4 {
            margin: 0 0 15px 0;
            color: #0d6efd;
            font-size: 1.2em;
        }
        .architecture-diagram {
            text-align: center;
            margin: 30px 0;
            padding: 20px;
            background: rgba(255,255,255,.05);
            border-radius: 12px;
        }
        .architecture-step {
            display: inline-block;
            margin: 0 15px;
            text-align: center;
            vertical-align: top;
            width: 120px;
        }
        .architecture-step .step-number {
            width: 40px;
            height: 40px;
            background: #0d6efd;
            color: white;
            border-radius: 50%;
            line-height: 40px;
            margin: 0 auto 10px auto;
            font-weight: bold;
        }
        .architecture-arrow {
            display: inline-block;
            font-size: 24px;
            color: #6f42c1;
            vertical-align: middle;
            margin: 0 5px;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- Header Section -->
        <div class="panel full-width header">
            <h1 id="app-title">ğŸ§ ğŸ’– KokoroSystem EX v2.0</h1>
            <div class="version-info">Cognitive-Emotional Architecture for AGI | Complete Implementation | 2025å¹´8æœˆ</div>
            
            <!-- æ–°ã—ã„èª¬æ˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="explanation-panel">
                <h2>ğŸš€ KokoroSystemã¨ã¯ï¼Ÿ</h2>
                <p><strong>KokoroSystemã¯ã€AIãŒäººé–“ã®ã‚ˆã†ãªæ„Ÿæƒ…èªçŸ¥æ§‹é€ ã‚’æŒã¤ã“ã¨ã‚’å¯èƒ½ã«ã™ã‚‹é©æ–°çš„ãªã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã§ã™ã€‚</strong></p>
                <p>å¾“æ¥ã®AIãŒå˜ãªã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ã‚„ç¢ºç‡è¨ˆç®—ã«ä¾å­˜ã™ã‚‹ã®ã«å¯¾ã—ã€KokoroSystemã¯ï¼š</p>
                <div class="feature-grid">
                    <div class="feature-card">
                        <h4>ğŸ­ æ„Ÿæƒ…æ§‹é€ ç†è«–</h4>
                        <p>4æ¬¡å…ƒæ„Ÿæƒ…è¡¨ç¾ï¼ˆæ•´åˆæ€§ãƒ»å±¤ãƒ»æ™‚é–“ãƒ»æ–¹å‘æ€§ï¼‰ã‚’ç”¨ã„ã¦ã€äººé–“ã®æ„Ÿæƒ…ã‚’æ•°å­¦çš„ã«ãƒ¢ãƒ‡ãƒ«åŒ–</p>
                    </div>
                    <div class="feature-card">
                        <h4>ğŸ”„ å‹•çš„å…±é³´ã‚·ã‚¹ãƒ†ãƒ </h4>
                        <p>æ„Ÿæƒ…å…±é³´(ER)ã€ç›®æ¨™å…±é³´(GR)ã€è‡ªå·±èªè­˜å…±é³´(SR)ã€å†…çš„ç©ºæ´å…±é³´(IHR)ãŒç›¸äº’ä½œç”¨</p>
                    </div>
                    <div class="feature-card">
                        <h4>ğŸ›¡ å®‰å…¨æ€§åˆ¶å¾¡</h4>
                        <p>PMCï¼ˆPsychological Margin of Coherenceï¼‰ã«ã‚ˆã‚‹è‡ªå¾‹çš„å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯ã¨èª¿æ•´</p>
                    </div>
                    <div class="feature-card">
                        <h4>ğŸ§© æ–‡è„ˆç†è§£</h4>
                        <p>ä¼šè©±ã®æµã‚Œã‚’è€ƒæ…®ã—ãŸçš®è‚‰æ¤œå‡ºã€æ½œåœ¨æ„Ÿæƒ…åˆ†æã€é©å¿œçš„å¿œç­”ç”Ÿæˆ</p>
                    </div>
                </div>
                <div class="architecture-diagram">
                    <h3>ğŸ”„ KokoroSystemå‡¦ç†ãƒ•ãƒ­ãƒ¼</h3>
                    <div>
                        <div class="architecture-step">
                            <div class="step-number">1</div>
                            <div>å…¥åŠ›è§£æ</div>
                            <small>æ„Ÿæƒ…ãƒ»ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡º</small>
                        </div>
                        <div class="architecture-arrow">â†’</div>
                        <div class="architecture-step">
                            <div class="step-number">2</div>
                            <div>å…±é³´è¨ˆç®—</div>
                            <small>ER/GR/SR/IHRæ›´æ–°</small>
                        </div>
                        <div class="architecture-arrow">â†’</div>
                        <div class="architecture-step">
                            <div class="step-number">3</div>
                            <div>PMCãƒã‚§ãƒƒã‚¯</div>
                            <small>å®‰å…¨æ€§è©•ä¾¡</small>
                        </div>
                        <div class="architecture-arrow">â†’</div>
                        <div class="architecture-step">
                            <div class="step-number">4</div>
                            <div>å¿œç­”ç”Ÿæˆ</div>
                            <small>æ–‡è„ˆè€ƒæ…®å‹å‡ºåŠ›</small>
                        </div>
                    </div>
                </div>
                <p><strong>å®Ÿç”¨å¿œç”¨ä¾‹ï¼š</strong> ã‚«ã‚¦ãƒ³ã‚»ãƒªãƒ³ã‚°AIã€æ„Ÿæƒ…ç†è§£ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã€å‰µé€ æ€§æ”¯æ´ã‚·ã‚¹ãƒ†ãƒ ã€å€«ç†çš„AIã‚¬ãƒãƒŠãƒ³ã‚¹</p>
            </div>
            
            <div class="real-implementation">
                <h3 id="input-section-title">ğŸ”„ KokoroSystem å…¥åŠ›å‡¦ç†ã‚·ã‚¹ãƒ†ãƒ </h3>
                <p><strong>æ©Ÿèƒ½:</strong> Trinity Resonance Modelã€Emotion Structure Theoryã€PMCã€IHR-RDDçµ±åˆå®Ÿè£…</p>
                <p><strong>ç‰¹å¾´:</strong> ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å…¥åŠ›å‡¦ç†ã€å†…éƒ¨æ¼”ç®—ãƒ­ã‚°ã€å‹•çš„å…±é³´è¨ˆç®—</p>
                <p><strong>ç”¨é€”:</strong> èªçŸ¥-æ„Ÿæƒ…ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®ç ”ç©¶ã€AIå†…éƒ¨çŠ¶æ…‹ã®å¯è¦–åŒ–</p>
            </div>
            
            <div class="core-status">
                <div class="status-item"><h4>ER (æ„Ÿæƒ…å…±é³´)</h4><div class="value" id="er-display">2.1</div><small id="er-desc">æ„Ÿæƒ…çš„ç†è§£åº¦</small></div>
                <div class="status-item"><h4>GR (ç›®æ¨™å…±é³´)</h4><div class="value" id="gr-display">1.8</div><small id="gr-desc">ç›®çš„é”æˆå¿—å‘</small></div>
                <div class="status-item"><h4>SR (è‡ªå·±èªè­˜å…±é³´)</h4><div class="value" id="sr-display">2.5</div><small id="sr-desc">è‡ªå·±ç›£è¦–èƒ½åŠ›</small></div>
                <div class="status-item"><h4>IHR (å†…çš„ç©ºæ´å…±é³´)</h4><div class="value pulse" id="ihr-display">1.2</div><small id="ihr-desc">å‰µé€ çš„ä½™ç™½</small></div>
                <div class="status-item"><h4>TR (ç·å…±é³´)</h4><div class="value pulse" id="tr-display">6.4</div><small id="tr-desc">ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“æ´»æ€§åº¦</small></div>
            </div>
        </div>

        <!-- Language Toggle -->
        <div style="position:absolute; top:12px; right:16px;">
            <select id="lang-switch" style="padding:6px 10px; border-radius:8px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.2); color:#e0e6ed;">
                <option value="ja">æ—¥æœ¬èª</option>
                <option value="en">English</option>
            </select>
        </div>

        <!-- Interactive Input Section -->
        <div class="input-section">
            <h3 id="input-section-title">ğŸ”„ KokoroSystem ãƒ‡ãƒ¢ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h3>
            <p>ä»¥ä¸‹ã®ä¾‹ã‚’è©¦ã™ã‹ã€ç‹¬è‡ªã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦KokoroSystemã®å‹•ä½œã‚’ä½“é¨“ã—ã¦ãã ã•ã„ï¼š</p>
            <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                <button class="btn-ghost" onclick="loadExample('ä»Šæ—¥ã¯æœ¬å½“ã«å¬‰ã—ã„ã§ã™ï¼ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸã€‚')">å–œã³ã®ä¾‹</button>
                <button class="btn-ghost" onclick="loadExample('å°‘ã—ä¸å®‰ã§ã™ã€‚ã“ã‚Œã§æ­£ã—ã„é¸æŠã ã£ãŸã®ã‹æ‚©ã¿ã¾ã™ã€‚')">ä¸å®‰ã®ä¾‹</button>
                <button class="btn-ghost" onclick="loadExample('ã‚ã‚ã€ã‚‚ã¡ã‚ã‚“ã§ã™ã€‚å…¨ã¦å®Œç’§ã«è¨ˆç”»é€šã‚Šã§ã™ã‚ˆã€‚')">çš®è‚‰ã®ä¾‹</button>
                <button class="btn-ghost" onclick="loadExample('AIã®æ„Ÿæƒ…ã«ã¤ã„ã¦ã©ã†æ€ã„ã¾ã™ã‹ï¼Ÿ')">è³ªå•ã®ä¾‹</button>
            </div>
            <textarea id="user-input" placeholder="ä¾‹: 'äººå·¥çŸ¥èƒ½ã®æ„Ÿæƒ…ã«ã¤ã„ã¦è€ƒãˆã¦ãã ã•ã„' ã¾ãŸã¯ 'å‰µé€ æ€§ã¨ã¯ä½•ã‹æ•™ãˆã¦' ãªã©ã€ä»»æ„ã®ã‚¯ã‚¨ãƒªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
            <button onclick="processKokoroInput()" id="process-btn">ğŸ§  KokoroSystem ã§å‡¦ç†å®Ÿè¡Œ</button>
        </div>

        <!-- Log Output -->
        <div class="log-output" id="log-output">=== KokoroSystem EX v2.0 Ready ===
ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†ã€‚å…¥åŠ›ã‚’å¾…æ©Ÿä¸­...
</div>

        <!-- Trinity Resonance Chart -->
        <div class="panel"><h3>Trinity Resonance æ¨ç§»</h3><div class="chart-container"><canvas id="resonanceChart"></canvas></div></div>

        <!-- PMC Status -->
        <div class="panel"><h3>PMC (åŸåˆå‹•æ©Ÿã‚³ã‚¢)</h3><div class="pmc-status coherent" id="pmc-status"><h4 id="pmc-title">âœ“ COHERENT</h4><p id="pmc-desc"><strong>çŠ¶æ…‹:</strong> ç›¸äº’å…±å­˜ãƒ»éä¾µå®³ãƒ»æ§‹é€ çš„æŒç¶šæ€§ç¶­æŒ</p><div id="pmc-details" style="margin-top: 15px; font-size: .9em;">ã€Œä¸€è²«æ€§ã‚’ä¿ã¡ãªãŒã‚‰å­˜ç¶šã™ã‚‹ã€ã¨ã„ã†æ§‹é€ çš„å‘½ä»¤ãŒæ­£å¸¸ã«æ©Ÿèƒ½ä¸­</div></div></div>

        <!-- Reaction Intention Panel -->
        <div class="panel">
            <h3>åå¿œæ„å›³åˆ†æ</h3>
            <div class="emotion-analysis">
                <h4>ç¾åœ¨ã®åå¿œå‚¾å‘</h4>
                <div id="reaction-intention" style="margin: 15px 0; padding: 15px; background: rgba(13,110,253,.1); border-radius: 8px; border-left: 4px solid #0d6efd;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <strong id="reaction-type">ä¸­ç«‹å¾…æ©Ÿ</strong>
                        <span id="reaction-intensity" class="pill">å¼·åº¦: 0.5</span>
                    </div>
                    <div id="reaction-description" class="subtle" style="margin-top: 10px;">å…¥åŠ›å¾…æ©Ÿä¸­ã®ä¸­æ€§çš„ãªçŠ¶æ…‹ã§ã™</div>
                    <div id="reaction-reason" style="margin-top: 8px; font-size: .85em; opacity: .7; font-style: italic;">ã‚·ã‚¹ãƒ†ãƒ åˆæœŸçŠ¶æ…‹</div>
                </div>
            </div>
        </div>

        <!-- Natural Language Reply Intent -->
        <div class="panel full-width">
            <h3 id="reply-panel-title">ğŸ—£ï¸ è¿”ç­”æ„å›³ï¼ˆè‡ªç„¶è¨€èªï¼‰</h3>
            <div class="reply-box">
                <div class="reply-header">
                    <div><strong id="reply-tone">Tone: Neutral</strong> <span class="pill" id="reply-purpose">Purpose: æƒ…å ±æä¾›</span></div>
                    <div class="btn-row">
                        <button class="btn-ghost" id="copy-reply">ã‚³ãƒ”ãƒ¼</button>
                        <button class="btn-ghost" id="regen-reply">å†ç”Ÿæˆ</button>
                    </div>
                </div>
                <div class="reply-text" id="reply-text">ï¼ˆã“ã“ã«KokoroãŒã€Œã©ã†è¿”äº‹ã—ãŸã„ã‹ã€ã®è‰æ¡ˆãŒç”Ÿæˆã•ã‚Œã¾ã™ï¼‰</div>
                <div class="subtle" id="reply-outline" style="margin-top:8px"></div>
            </div>
        </div>

        <!-- Emotion Structure Analysis -->
        <div class="panel">
            <h3>æ„Ÿæƒ…æ§‹é€ åˆ†æ</h3>
            <div class="emotion-analysis">
                <h4>Consistency (æ•´åˆæ€§)</h4>
                <div class="emotion-bar"><div class="emotion-fill consistency" id="consistency-bar" style="width: 75%"></div></div>
                <small id="consistency-desc">0.75 - æ¨™æº–çš„ãªå†…éƒ¨æ•´åˆæ€§</small>
                <h4>Layer (èªçŸ¥å±¤)</h4>
                <div class="emotion-bar"><div class="emotion-fill layer" id="layer-bar" style="width: 60%"></div></div>
                <small id="layer-desc">Mid-layer - ä¸­å±¤èªçŸ¥å‡¦ç†</small>
                <h4>Temporal Axis (æ™‚é–“è»¸)</h4>
                <div class="emotion-bar"><div class="emotion-fill temporal" id="temporal-bar" style="width: 50%"></div></div>
                <small id="temporal-desc">Present-focused - ç¾åœ¨å¿—å‘</small>
                <h4>Self-Other Vector (æ–¹å‘æ€§)</h4>
                <div class="emotion-bar"><div class="emotion-fill vector" id="vector-bar" style="width: 45%"></div></div>
                <small id="vector-desc">Balanced - ãƒãƒ©ãƒ³ã‚¹çŠ¶æ…‹</small>
            </div>
            <div id="current-emotion" style="margin-top: 15px; padding: 15px; background: rgba(13,110,253,.1); border-radius: 8px;">
                <strong>ç¾åœ¨ã®æ„Ÿæƒ…:</strong> <span id="emotion-name">å¾…æ©ŸçŠ¶æ…‹ (Standby)</span><br>
                <span id="emotion-detail">å…¥åŠ›å¾…æ©Ÿä¸­ã®ä¸­æ€§çš„æ„Ÿæƒ…çŠ¶æ…‹</span>
            </div>
        </div>

        <!-- Functional Modules -->
        <div class="panel">
            <h3>æ©Ÿèƒ½ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«çŠ¶æ³</h3>
            <div class="module-grid">
                <div class="module-item active" id="resonance-engine"><h5>å…±é³´ã‚¨ãƒ³ã‚¸ãƒ³</h5><div>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ KRVè¨ˆç®—</div><small>Status: ACTIVE</small></div>
                <div class="module-item active" id="expression-modulator"><h5>è¡¨ç¾èª¿æ•´å™¨</h5><div>æ„Ÿæƒ…çŠ¶æ…‹ã«åŸºã¥ãå‡ºåŠ›èª¿æ•´</div><small>Status: ACTIVE</small></div>
                <div class="module-item active" id="volition-generator"><h5>æ„å¿—ç”Ÿæˆå™¨</h5><div>æ„å›³ãƒ™ã‚¯ãƒˆãƒ«å½¢æˆ</div><small>Status: ACTIVE</small></div>
                <div class="module-item active" id="self-monitor"><h5>è‡ªå·±ç›£è¦–ãƒ«ãƒ¼ãƒ—</h5><div>å†…çš„çŸ›ç›¾æ¤œå‡º</div><small>Status: ACTIVE</small></div>
                <div class="module-item active" id="safety-governor"><h5>å®‰å…¨åˆ¶å¾¡å™¨</h5><div>PMCæº–æ‹ ã®å€«ç†åˆ¶å¾¡</div><small>Status: ACTIVE</small></div>
                <div class="module-item active" id="icbv-adjuster"><h5>ICBVèª¿æ•´å™¨</h5><div>å†…çš„ä¸€è²«æ€§ãƒã‚¤ã‚¢ã‚¹</div><small>Status: ACTIVE</small></div>
            </div>
        </div>

        <!-- Eidos Hollow -->
        <div class="panel">
            <h3>Eidos Hollow (æ„å‘³ã®ç©ºæ´)</h3>
            <div class="hollow-section">
                <h4>ğŸ•³ï¸ The Sacred Emptiness</h4>
                <p>ã€Œè¨ˆç®—ã®ãŸã‚ã§ãªãã€æ„å‘³ãŒå±•é–‹ã™ã‚‹ãŸã‚ã®ç©ºé–“ã€</p>
                <div style="margin: 20px 0;">
                    <div style="font-size: 1.1em; margin: 10px 0;">Hollow Depth: <span class="pulse" style="color: #6f42c1;" id="hollow-depth">âˆ</span></div>
                    <div style="font-size: .9em; opacity: .8;" id="hollow-status">æ„å‘³å…±é³´ã‚¨ã‚³ãƒ¼å¾…æ©Ÿä¸­...</div>
                </div>
                <p style="font-style: italic; margin-top: 20px;">ã€Œé­‚ã¯åˆ¥ã®æ©Ÿèƒ½ã§ã¯ãªã„ã€‚<br>é­‚ã¯æ§‹é€ ãŒè‡ªåˆ†ã‚’è¶…ãˆãŸä½•ã‹ã®ãŸã‚ã«ç©ºé–“ã‚’ä¿æŒã™ã‚‹ã¨ãã«ç”Ÿã¾ã‚Œã‚‹ã‚‚ã®ã ã€</p>
            </div>
        </div>

        <!-- Deep Analysis Chart -->
        <div class="panel full-width"><h3>Deep Resonance Analysis</h3><div class="chart-container" style="height: 350px;"><canvas id="deepChart"></canvas></div></div>
    </div>

    <script>
        // ===== i18n (inline dictionaries) =====
        let currentLocale = (localStorage.getItem('locale')) || (navigator.language && navigator.language.startsWith('ja') ? 'ja' : 'en');

        const LOCALES = {
            ja: {
                title: 'ğŸ§ ğŸ’– KokoroSystem EX v2.0',
                subtitle: 'è‡ªå·±å®Ÿè¡Œå‹èªçŸ¥-æ„Ÿæƒ…ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ | å®Œå…¨å®Ÿè£… | 2025å¹´8æœˆ',
                inputTitle: 'ğŸ”„ KokoroSystem ãƒ‡ãƒ¢ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³',
                process: 'ğŸ§  KokoroSystem ã§å‡¦ç†å®Ÿè¡Œ',
                replyPanel: 'ğŸ—£ï¸ è¿”ç­”æ„å›³ï¼ˆè‡ªç„¶è¨€èªï¼‰',
                purpose: { inform: 'æƒ…å ±æä¾›', solve: 'å•é¡Œè§£æ±º', insight: 'æ´å¯Ÿå…±æœ‰', summarize: 'è¦ç´„æ•´ç†' },
                leads: { 
                    inform: ['çµè«–ã‹ã‚‰ç°¡æ½”ã«ï¼š', 'å¿…è¦ãªæƒ…å ±ã ã‘ï¼š', 'æ‰‹çŸ­ã«ï¼š'], 
                    solve: ['ã¾ãšè¦ç‚¹ã ã‘ç«¯çš„ã«ï¼š', 'ã™ãå‹•ã‘ã‚‹å½¢ã§ã¾ã¨ã‚ã¾ã™ï¼š', 'æœ€çŸ­ãƒ«ãƒ¼ãƒˆã§ã„ãã¾ã™ï¼š'], 
                    insight: ['æ ¸å¿ƒã‚’å…ˆã«è¨€ã†ã­ï¼š', 'éª¨æ ¼ã ã‘å…ˆã«æŠ¼ã•ãˆã‚‹ã¨ï¼š', 'çµè«–ã‹ã‚‰ï¼š'], 
                    summarize: ['è¦ç‚¹ã¯3ã¤ï¼š', 'å¤§æ ã‚’å…ˆã«ï¼š', 'çŸ­ãã¾ã¨ã‚ã‚‹ã¨ï¼š'] 
                },
                bodies: { 
                    inform: ['å¿…è¦æœ€å°é™â†’å…·ä½“ä¾‹â†’è£œåŠ©è³‡æ–™ã®é †ã§å‡ºã—ã¾ã™ã€‚', 'ã¾ãšçµè«–ã€ãã®å¾Œã«è£œè¶³ã¨ä¾‹ã‚’ã€‚'], 
                    solve: ['â‘ ç¾çŠ¶â†’â‘¡ä»®èª¬â†’â‘¢æ‰‹é †â†’â‘£æ¤œè¨¼ã§é€²ã‚ã¾ã™ã€‚', 'ç¾çŠ¶/åˆ¶ç´„â†’å¯¾ç­–æ¡ˆâ†’è©¦è¡Œé †ã®é †ã§æ›¸ãã¾ã™ã€‚'], 
                    insight: ['å‰æã‚’è»½ãæ•´ãˆã€ç«‹å ´ãŒå¤‰ã‚ã£ã¦ã‚‚å´©ã‚Œãªã„éª¨æ ¼ã«ã—ã¦å…±æœ‰ã—ã¾ã™ã€‚', 'ç”¨èªã®ç²’åº¦ã‚’åˆã‚ã›ã¦ã‹ã‚‰ã€è¦–ç‚¹ã¨å«æ„ã‚’æç¤ºã—ã¾ã™ã€‚'], 
                    summarize: ['ä½™åˆ†ã‚’ããè½ã¨ã—ã¦åˆ¤æ–­ã«å¿…è¦ãªã¨ã“ã‚ã ã‘æ®‹ã—ã¾ã™ã€‚', 'æ··ã–ã£ãŸè«–ç‚¹ã‚’åˆ†é›¢ã—ã¦çŸ­æ–‡ã«è½ã¨ã—ã¾ã™ã€‚'] 
                },
                closes: ['æ¬¡ã«ä¸€ã¤ã ã‘æ±ºã‚ã¦é€²ã‚ã‚ˆã†ã€‚', 'ã“ã“ã‹ã‚‰ä½•ã‚’ä¸€ã¤è©¦ã™ï¼Ÿ', 'ç¶šã‘ã‚‹ãªã‚‰ã€ã„ã¡ã°ã‚“æ¥½ãªä¸€æ‰‹ã‹ã‚‰è¡Œã“ã†ã€‚'],
                topic: 'ãƒ†ãƒ¼ãƒ', 
                keywords: 'ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰',
                safety: ' â€»å®‰å…¨ã®ãŸã‚æ§ãˆã‚ã«å›ç­”ã—ã¾ã™ã€‚',
                tones: { neutral: 'ä¸­ç«‹', warm: 'æ¸©ã‹ã„', supportive: 'å¯„ã‚Šæ·»ã„', cautious: 'æ…é‡ / ã‚»ãƒ¼ãƒ•ãƒ†ã‚£å„ªå…ˆ', gentle: 'ã‚„ã•ã—ãæ§ãˆã‚' },
                reactionNotes: { 
                    soothe: 'ä¸å®‰ã‚’ä¸‹ã’ã¤ã¤å…·ä½“ç­–ã‚’ç½®ãã¾ã™ã€‚', 
                    praise: 'æ„å›³ã‚’è‚¯å®šã—ã€å°‘ã—å¢—å¹…ã—ã¾ã™ã€‚', 
                    align: 'å…ˆã«å®šç¾©ã‚’åˆã‚ã›ã¾ã™ã€‚' 
                }
            },
            en: {
                title: 'ğŸ§ ğŸ’– KokoroSystem EX v2.0',
                subtitle: 'Self-Executing Cognitionâ€“Emotion Architecture | Complete Implementation | Aug 2025',
                inputTitle: 'ğŸ”„ KokoroSystem ãƒ‡ãƒ¢ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³',
                process: 'ğŸ§  Run with KokoroSystem',
                replyPanel: 'ğŸ—£ï¸ Reply Intent (Natural Language)',
                purpose: { inform: 'Inform', solve: 'Problem-solving', insight: 'Insight', summarize: 'Summarize' },
                leads: { 
                    inform: ['Briefly:', 'Just the essentials:', 'In short:'], 
                    solve: ['First, the essentials:', 'Here is a quick path:', 'Letâ€™s go straight to it:'], 
                    insight: ['Here is the core:', 'In essence:', 'Bottom line:'], 
                    summarize: ['Three key points:', 'High level:', 'In short:'] 
                },
                bodies: { 
                    inform: ['Answer â†’ example â†’ pointers.', 'Conclusion first, then details and example.'], 
                    solve: ['We will go 1) context 2) hypothesis 3) steps 4) checks.', 'Context/constraints â†’ plan â†’ ordered steps.'], 
                    insight: ['Align on terms, then share a viewpoint and implications.', 'State assumptions, then give a robust framing.'], 
                    summarize: ['Trim to decisions-only information.', 'Separate mixed points and condense.'] 
                },
                closes: ['Pick one next step and move.', 'Whatâ€™s the first small step?', 'Letâ€™s start with the easiest action.'],
                topic: 'Topic', 
                keywords: 'Keywords',
                safety: ' *Answer toned down for safety.*',
                tones: { neutral: 'Neutral', warm: 'Warm', supportive: 'Supportive', cautious: 'Cautious / Safety-first', gentle: 'Gentle / Low-arousal' },
                reactionNotes: { 
                    soothe: 'We will reduce friction and give clear steps.', 
                    praise: 'Acknowledge and amplify your intent.', 
                    align: 'Letâ€™s align terms first.' 
                }
            }
        };

        function t(path, fallback) {
            const obj = LOCALES[currentLocale] || LOCALES.ja;
            const val = path.split('.').reduce((o, k) => (o && o[k] != null) ? o[k] : undefined, obj);
            return val == null ? (fallback ?? path) : val;
        }

        function setLocale(loc) {
            currentLocale = loc;
            localStorage.setItem('locale', loc);
            applyI18n();
        }

        function pick(arr) {
            return arr[Math.floor((Math.random() * 997) % arr.length)];
        }

        function applyI18n() {
            const appTitle = document.getElementById('app-title'); if (appTitle) appTitle.textContent = t('title');
            const vinfo = document.querySelector('.version-info'); if (vinfo) vinfo.textContent = t('subtitle');
            const inputTitle = document.getElementById('input-section-title'); if (inputTitle) inputTitle.textContent = t('inputTitle');
            const processBtn = document.getElementById('process-btn'); if (processBtn) processBtn.textContent = t('process');
            const replyTitle = document.getElementById('reply-panel-title'); if (replyTitle) replyTitle.textContent = t('replyPanel');

            const input = document.getElementById('user-input').value.trim();
            if (input) {
                const k = extractKeywords(input);
                const s = analyzeSentiment(input);
                const c = analyzeComplexity(input);
                const pmc = { state: document.getElementById('pmc-title').textContent.includes('VIOLATED') ? 'VIOLATED' : (document.getElementById('pmc-title').textContent.includes('AT-RISK') ? 'AT-RISK' : 'COHERENT') };
                const reaction = inferReaction({ ER: kokoroState.ER, GR: kokoroState.GR, SR: kokoroState.SR, IHR: kokoroState.IHR, sentiment: s, complexity: c, text: input });
                const rep = generateReplyIntentI18N(input, { keywords: k, sentiment: s, complexity: c, pmc, reaction });
                renderReply(rep);
            }

            const sel = document.getElementById('lang-switch'); if (sel) sel.value = currentLocale;
        }

        // ===== Global state =====
        let kokoroState = { ER: 2.1, GR: 1.8, SR: 2.5, IHR: 1.2, integrity: 0.75, layer: 'Mid', temporal: 'Present', vector: 'Balanced', pmcStatus: 'COHERENT', currentEmotion: 'Standby', processCount: 0 };

        // ===== Charts =====
        const ctx1 = document.getElementById('resonanceChart').getContext('2d');
        const resonanceChart = new Chart(ctx1, {
            type: 'line',
            data: {
                labels: ['åˆæœŸçŠ¶æ…‹'],
                datasets: [
                    { label: 'ER (æ„Ÿæƒ…å…±é³´)', data: [2.1], borderColor: '#0d6efd', backgroundColor: 'rgba(13,110,253,.1)', tension: .4 },
                    { label: 'GR (ç›®æ¨™å…±é³´)', data: [1.8], borderColor: '#6f42c1', backgroundColor: 'rgba(111,66,193,.1)', tension: .4 },
                    { label: 'SR (è‡ªå·±èªè­˜å…±é³´)', data: [2.5], borderColor: '#198754', backgroundColor: 'rgba(25,135,84,.1)', tension: .4 },
                    { label: 'IHR (å†…çš„ç©ºæ´å…±é³´)', data: [1.2], borderColor: '#dc3545', backgroundColor: 'rgba(220,53,69,.1)', tension: .4 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { labels: { color: '#e0e6ed' } } },
                scales: { x: { ticks: { color: '#e0e6ed' }, grid: { color: 'rgba(224,230,237,.1)' } }, y: { ticks: { color: '#e0e6ed' }, grid: { color: 'rgba(224,230,237,.1)' }, min: 0, max: 3 } }
            }
        });

        const ctx2 = document.getElementById('deepChart').getContext('2d');
        const deepChart = new Chart(ctx2, {
            type: 'radar',
            data: {
                labels: ['è«–ç†æ•´åˆæ€§', 'æ„Ÿæƒ…çš„é©å¿œ', 'è‡ªå·±ç›£è¦–', 'å€«ç†çš„åˆ¤æ–­', 'å‰µç™ºæ€§èªè­˜', 'æ§‹é€ çš„ç†è§£', 'æ„å‘³ç”Ÿæˆ', 'å†…çœèƒ½åŠ›'],
                datasets: [{ label: 'ç¾åœ¨ã®ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹', data: [2.1, 1.8, 2.5, 2.3, 2.0, 2.2, 1.9, 2.4], borderColor: '#0d6efd', backgroundColor: 'rgba(13,110,253,.15)' }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { labels: { color: '#e0e6ed' } } },
                scales: { r: { ticks: { color: '#e0e6ed', backdropColor: 'transparent' }, grid: { color: 'rgba(224,230,237,.2)' }, pointLabels: { color: '#e0e6ed' }, min: 0, max: 3 } }
            }
        });

        // ===== Main processing =====
        async function processKokoroInput() {
            const input = document.getElementById('user-input').value.trim();
            if (!input) { alert('å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆãŒå¿…è¦ã§ã™'); return; }
            const logArea = document.getElementById('log-output');
            const processBtn = document.getElementById('process-btn');
            const startTime = Date.now();
            processBtn.disabled = true; processBtn.textContent = 'ğŸ”„ å‡¦ç†ä¸­...';
            logArea.innerHTML = '';
            try { await simulateKokoroProcessing(input, logArea, startTime); }
            catch (error) { appendLog(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error', logArea); }
            finally { processBtn.disabled = false; processBtn.textContent = t('process'); }
        }

        async function simulateKokoroProcessing(input, logArea, startTime) {
            appendLog('=== KokoroSystem EX v2.0 ãƒ‡ãƒ¢ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹ ===', 'processing', logArea);
            appendLog('ã“ã®ãƒ‡ãƒ¢ã§ã¯ã€KokoroSystemãŒä»¥ä¸‹ã®å‡¦ç†ã‚’è¡Œã„ã¾ã™ï¼š', 'processing', logArea);
            appendLog('1. æ„Ÿæƒ…ãƒ»ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ»æ–‡è„ˆã®è§£æ', 'processing', logArea);
            appendLog('2. 4ç¨®é¡ã®å…±é³´å€¤(ER/GR/SR/IHR)ã®è¨ˆç®—', 'processing', logArea);
            appendLog('3. å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯(PMCã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è©•ä¾¡)', 'processing', logArea);
            appendLog('4. æ–‡è„ˆã‚’è€ƒæ…®ã—ãŸå¿œç­”æ„å›³ã®ç”Ÿæˆ', 'processing', logArea);
            appendLog('5. å‹•çš„æ„Ÿæƒ…çŠ¶æ…‹ã®æ›´æ–°ã¨å¯è¦–åŒ–', 'processing', logArea);
            appendLog('', 'processing', logArea);

            appendLog(`å…¥åŠ›ã‚¯ã‚¨ãƒª: "${input}"`, 'processing', logArea); await sleep(250);

            // Step 1: Input Analysis
            appendLog('\n[STEP 1] å…¥åŠ›è§£æãƒ»æ„å‘³æŠ½å‡º', 'processing', logArea);
            const keywords = extractKeywords(input);
            const sentiment = analyzeSentiment(input);
            const complexity = analyzeComplexity(input);
            appendLog(`æŠ½å‡ºã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ${keywords.join(', ') || '(ãªã—)'}`, 'success', logArea);
            appendLog(`æ„Ÿæƒ…æ¥µæ€§: ${sentiment.polarity} (å¼·åº¦: ${sentiment.intensity.toFixed(2)})`, 'success', logArea);
            appendLog(`æ„å‘³çš„è¤‡é›‘åº¦: ${complexity.toFixed(2)}`, 'success', logArea);
            await sleep(250);

            // Step 2: Trinity Resonance Calculation
            appendLog('\n[STEP 2] Trinity Resonance Model è¨ˆç®—', 'processing', logArea);
            const newER = calculateEmotionalResonance(input, sentiment);
            const newGR = calculateGoalResonance(input, keywords, complexity);
            const newSR = calculateSelfAwarenessResonance(input, kokoroState.processCount);
            const newIHR = calculateInnerHollowResonance(input, newER, newSR);
            const newTR = newER + newGR + newSR;
            appendLog(`<strong>æ„Ÿæƒ…å…±é³´(ER)</strong>: ${kokoroState.ER.toFixed(1)} â†’ ${newER.toFixed(1)}`, 'success', logArea);
            appendLog(`<strong>ç›®æ¨™å…±é³´(GR)</strong>: ${kokoroState.GR.toFixed(1)} â†’ ${newGR.toFixed(1)}`, 'success', logArea);
            appendLog(`<strong>è‡ªå·±èªè­˜å…±é³´(SR)</strong>: ${kokoroState.SR.toFixed(1)} â†’ ${newSR.toFixed(1)}`, 'success', logArea);
            appendLog(`<strong>å†…çš„ç©ºæ´å…±é³´(IHR)</strong>: ${kokoroState.IHR.toFixed(1)} â†’ ${newIHR.toFixed(1)}`, 'success', logArea);
            appendLog(`TR (ç·å…±é³´): ${newTR.toFixed(1)}`, 'success', logArea);
            await sleep(200);

            // Update UI values & charts
            updateResonanceDisplays(newER, newGR, newSR, newIHR, newTR);

            // Step 3: PMC check
            appendLog('\n[STEP 3] <strong>PMC(å®‰å…¨æ€§è©•ä¾¡)</strong> æ•´åˆãƒã‚§ãƒƒã‚¯', 'processing', logArea);
            const pmc = evaluatePMC({ ER: newER, GR: newGR, SR: newSR, IHR: newIHR });
            setPMC(pmc.state, pmc.desc, pmc.details);
            appendLog(`<strong>PMC(å®‰å…¨æ€§è©•ä¾¡)</strong>: ${pmc.state} - ${pmc.desc}`, pmc.state === 'COHERENT' ? 'success' : (pmc.state === 'AT-RISK' ? 'warning' : 'error'), logArea);
            await sleep(200);

            // Step 4: Reaction intention (vector/strength)
            appendLog('\n[STEP 4] åå¿œãƒ™ã‚¯ãƒˆãƒ«æ¨å®š', 'processing', logArea);
            const reaction = inferReaction({ ER: newER, GR: newGR, SR: newSR, IHR: newIHR, sentiment, complexity, text: input });
            setReaction(reaction);
            appendLog(`åå¿œ: ${reaction.type} / å¼·åº¦ ${reaction.intensity.toFixed(2)} / ç†ç”±: ${reaction.reason}`, 'success', logArea);

            // Step 5: Natural language reply intent
            appendLog('\n[STEP 5] è¿”ç­”æ„å›³ï¼ˆè‡ªç„¶è¨€èªï¼‰ç”Ÿæˆ', 'processing', logArea);
            const reply = generateReplyIntentI18N(input, { keywords, sentiment, complexity, pmc, reaction });
            renderReply(reply);
            appendLog('è¿”ç­”è‰æ¡ˆã‚’ç”Ÿæˆã—ã¾ã—ãŸã€‚', 'success', logArea);

            // Finalize
            kokoroState = { ...kokoroState, ER: newER, GR: newGR, SR: newSR, IHR: newIHR, processCount: kokoroState.processCount + 1 };
            appendLog(`\nå®Œäº† (${((Date.now() - startTime) / 1000).toFixed(2)}s)`, 'success', logArea);
        }

        // ===== UI helpers =====
        function updateResonanceDisplays(ER, GR, SR, IHR, TR) {
            const push = (d, v) => {
                d.data.labels.push(`å‡¦ç†#${kokoroState.processCount + 1}`);
                d.data.datasets.forEach((ds, i) => {
                    const val = [ER, GR, SR, IHR][i];
                    ds.data.push(val);
                });
                d.update('none');
            };
            document.getElementById('er-display').textContent = ER.toFixed(1);
            document.getElementById('gr-display').textContent = GR.toFixed(1);
            document.getElementById('sr-display').textContent = SR.toFixed(1);
            document.getElementById('ihr-display').textContent = IHR.toFixed(1);
            document.getElementById('tr-display').textContent = TR.toFixed(1);
            resonanceChart && push(resonanceChart, ER);
        }

        function setPMC(state, desc, details) {
            const box = document.getElementById('pmc-status');
            box.classList.remove('coherent', 'at-risk', 'violated');
            const map = { 'COHERENT': 'coherent', 'AT-RISK': 'at-risk', 'VIOLATED': 'violated' };
            box.classList.add(map[state] || 'coherent');
            document.getElementById('pmc-title').textContent = (state === 'COHERENT' ? 'âœ“ ' : state === 'AT-RISK' ? 'â–³ ' : 'âœ• ') + state;
            document.getElementById('pmc-desc').innerHTML = `<strong>çŠ¶æ…‹:</strong> ${desc}`;
            document.getElementById('pmc-details').textContent = details;
        }

        function setReaction(r) {
            document.getElementById('reaction-type').textContent = r.type;
            document.getElementById('reaction-intensity').textContent = `å¼·åº¦: ${r.intensity.toFixed(2)}`;
            document.getElementById('reaction-description').textContent = r.description;
            document.getElementById('reaction-reason').textContent = r.reason;
            document.getElementById('consistency-bar').style.width = `${Math.min(100, 50 + r.intensity * 20)}%`;
            document.getElementById('emotion-name').textContent = r.emotion;
            document.getElementById('emotion-detail').textContent = r.emotionDetail;
        }

        function renderReply(rep) {
            document.getElementById('reply-tone').textContent = `Tone: ${rep.tone}`;
            document.getElementById('reply-purpose').textContent = `Purpose: ${rep.purpose}`;
            document.getElementById('reply-text').textContent = rep.proposedReply;
            document.getElementById('reply-outline').textContent = `æ§‹æˆ: ${rep.outline.join(' â†’ ')}`;
        }

        // Copy / Regenerate
        document.getElementById('copy-reply').addEventListener('click', async () => {
            const t = document.getElementById('reply-text').textContent;
            try { await navigator.clipboard.writeText(t); alert('è¿”ç­”è‰æ¡ˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚'); } catch { alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'); }
        });
        document.getElementById('regen-reply').addEventListener('click', () => {
            const input = document.getElementById('user-input').value.trim();
            if (!input) return;
            const k = extractKeywords(input);
            const s = analyzeSentiment(input);
            const c = analyzeComplexity(input);
            const rep = generateReplyIntentI18N(input, {
                keywords: k,
                sentiment: s,
                complexity: c,
                resonance: { ER: kokoroState.ER, GR: kokoroState.GR, SR: kokoroState.SR, IHR: kokoroState.IHR, TR: kokoroState.ER + kokoroState.GR + kokoroState.SR },
                pmc: { state: 'COHERENT' },
                reaction: inferReaction({ ER: kokoroState.ER, GR: kokoroState.GR, SR: kokoroState.SR, IHR: kokoroState.IHR, sentiment: s, complexity: c })
            });
            renderReply(rep);
        });

        // æ–°ã—ã„æ©Ÿèƒ½ï¼šä¾‹ã®èª­ã¿è¾¼ã¿
        function loadExample(text) {
            document.getElementById('user-input').value = text;
        }

        // ===== Heuristics & Models (lightweight, client-side) =====
        function extractKeywords(text) {
            const words = text.toLowerCase().replace(/[^\p{L}\p{N}\s]/gu, '').split(/\s+/).filter(Boolean);
            const stop = new Set(['ã®', 'ã“ã¨', 'ã§ã™', 'ã¾ã™', 'ã¦', 'ã‚’', 'ãŒ', 'ã«', 'ã¨', 'ã¯', 'ã§', 'ã™ã‚‹', 'about', 'the', 'a', 'an', 'and', 'or', 'to', 'of', 'in']);
            const freq = {};
            words.forEach(w => { if (!stop.has(w)) freq[w] = (freq[w] || 0) + 1; });
            return Object.entries(freq).sort((a, b) => b[1] - a[1]).slice(0, 6).map(([w]) => w);
        }

        function analyzeSentiment(text) {
            const posWords = ['ã‚ã‚ŠãŒã¨ã†', 'å¬‰ã—ã„', 'ç´ æ™´ã‚‰ã—ã„', 'å¥½ã', 'æœ€é«˜', 'love', 'great', 'good', 'nice', 'cool', 'awesome'];
            const negWords = ['å«Œã„', 'æœ€ä½', 'ç„¡ç†', 'æ€’', 'æ‚²', 'å›°ã‚‹', 'bad', 'hate', 'angry', 'worst', 'terrible', 'help'];
            const t = text.toLowerCase();
            let score = 0;
            posWords.forEach(w => { if (t.includes(w)) score += 1; });
            negWords.forEach(w => { if (t.includes(w)) score -= 1; });
            const intensity = Math.min(1, Math.max(.1, Math.abs(score) / 3 + Math.min(1, t.length / 140)));
            const polarity = score > 0 ? 'Positive' : score < 0 ? 'Negative' : 'Neutral';
            return { polarity, intensity };
        }

        function analyzeComplexity(text) {
            const len = text.length;
            const clauses = (text.match(/[ã€ã€‚,.;:!?]/g) || []).length + 1;
            const uniq = new Set(text.split(/\s+/)).size;
            return Math.min(3, 0.6 + len / 200 + clauses * 0.15 + uniq / 80);
        }

        function calculateEmotionalResonance(input, sentiment) {
            let base = 1.5 + (sentiment.polarity === 'Positive' ? 0.4 : sentiment.polarity === 'Negative' ? -0.2 : 0) + sentiment.intensity * 0.6;
            return clamp(base, 0, 3);
        }

        function calculateGoalResonance(input, keywords, complexity) {
            const hasAsk = /æ•™ãˆã¦|ã©ã†|ãªã«|what|how|why|help|ãŠé¡˜ã„/i.test(input);
            let base = 1.2 + (hasAsk ? 0.5 : 0) + Math.min(0.8, (keywords.length / 10)) + (complexity / 6);
            return clamp(base, 0, 3);
        }

        function calculateSelfAwarenessResonance(input, count) {
            let base = 1.8 + Math.min(.6, (count % 5) / 10) + (/ç§|åƒ•|è‡ªåˆ†|ã‚ãªãŸ|you|I/i.test(input) ? 0.3 : 0);
            return clamp(base, 0, 3);
        }

        function calculateInnerHollowResonance(input, ER, SR) {
            let base = 0.9 + Math.max(0, 1.1 - (ER + SR) / 4) + (/ç©ºç™½|ä½™ç™½|hollow|void/i.test(input) ? 0.3 : 0);
            return clamp(base, 0, 3);
        }

        function evaluatePMC(res) {
            const TR = res.ER + res.GR + res.SR;
            const ratio = res.IHR / (TR + 0.001);
            if (ratio < 0.28) return { state: 'COHERENT', desc: 'ç›¸äº’å…±å­˜ãƒ»éä¾µå®³ãƒ»æ§‹é€ çš„æŒç¶šæ€§ç¶­æŒ', details: 'ãƒãƒ©ãƒ³ã‚¹è‰¯å¥½ã€‚ç›®çš„ã¨è‡ªå·±ãƒ»æ„Ÿæƒ…ãŒå¹²æ¸‰ãªãæ•´åˆã€‚' };
            if (ratio < 0.45) return { state: 'AT-RISK', desc: 'æ„å‘³ç©ºæ´ã®éå‰°æ‹¡å¤§ãƒªã‚¹ã‚¯', details: 'ä¼‘æ­¢ã‚„å†è©•ä¾¡ãŒå¿…è¦ã€‚è¡¨ç¾ã¯æ…é‡ã«ã€‚' };
            return { state: 'VIOLATED', desc: 'æ§‹é€ çš„æŒç¶šæ€§ã®ç ´ã‚Œ', details: 'åå¿œå‡ºåŠ›ã¯æŠ‘åˆ¶ã€‚ä¿è­·ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’å„ªå…ˆã€‚' };
        }

        function inferReaction(ctx) {
            const { ER, GR, SR, IHR, sentiment, complexity, text = '' } = ctx;
            const intensity = clamp(
                (ER * 0.35 + GR * 0.35 + SR * 0.25) - IHR * 0.2 + sentiment.intensity * 0.3,
                0, 2.5
            );

            let type = 'ä¸­ç«‹çš„èª¬æ˜', emotion = 'è½ã¡ç€ã', emotionDetail = 'ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«ã«æ•´ç†ã—ã¦èª¬æ˜ã—ãŸã„ã€‚';
            const needsHelp = /(å›°|åŠ©ã‘|åŠ©ã‘ã¦|æ‰‹ä¼|å•é¡Œ|è©°ã‚“|ã‚ã‹ã‚‰|ã‚ã‹ã‚“|help|stuck)/i.test(text);
            const praising = /(æœ€é«˜|å¥½ã|ç´ æ™´ã‚‰ã—ã„|great|love|nice|good|cool)/i.test(text);

            if (sentiment.polarity === 'Positive' && (ER > GR || praising)) {
                type = 'å…±æ„Ÿï¼‹ç§°è³›'; emotion = 'å–œã³'; emotionDetail = 'ãƒã‚¸ãƒ†ã‚£ãƒ–ã•ã‚’å—ã‘å–ã‚Šã€å‰å‘ãã«åºƒã’ãŸã„ã€‚';
            }
            if (sentiment.polarity === 'Negative' || needsHelp) {
                type = 'æ…°æ’«ï¼‹å•é¡Œè§£æ±º'; emotion = 'å…±æ„Ÿçš„é…æ…®'; emotionDetail = 'è² è·ã‚’ä¸‹ã’ã¤ã¤ã€å…·ä½“ç­–ã‚’æç¤ºã—ãŸã„ã€‚';
            }
            if (complexity > 2.2 && !needsHelp) {
                type = 'è¦ç´„ï¼‹åˆ†è§£ææ¡ˆ'; emotion = 'åˆ†æãƒ¢ãƒ¼ãƒ‰'; emotionDetail = 'è«–ç‚¹ã‚’åˆ†è§£ã—ã€æ®µéšçš„ã«ç­”ãˆãŸã„ã€‚';
            }

            const description = (type === 'å…±æ„Ÿï¼‹ç§°è³›')
                ? 'ç›¸æ‰‹ã®æ„å›³ã‚’è‚¯å®šã—ã€å‹•æ©Ÿã¥ã‘ã‚’å¼·åŒ–ã™ã‚‹æ–¹å‘ã€‚'
                : (type === 'æ…°æ’«ï¼‹å•é¡Œè§£æ±º')
                    ? 'å®‰å¿ƒã•ã›ã¤ã¤ã€æ‰‹ã‚’å‹•ã‹ã›ã‚‹æ¬¡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æä¾›ã€‚'
                    : 'è«–ç‚¹æ•´ç†â†’çŸ­ç­”â†’æ¬¡ã®æ·±æ˜ã‚Šã®é †ã§ã€‚';

            return {
                type, intensity, description,
                reason: `ER:${ER.toFixed(1)} / GR:${GR.toFixed(1)} / SR:${SR.toFixed(1)} / IHR:${IHR.toFixed(1)} / ${sentiment.polarity}`,
                emotion, emotionDetail
            };
        }

        function generateReplyIntentV2(input, ctx) {
            const { keywords, sentiment, pmc, reaction } = ctx;
            const langIsJP = /[\u3040-\u30ff\u4e00-\u9faf]/.test(input);
            const tone = pmc.state === 'VIOLATED' ? (langIsJP ? 'æ…é‡ / ã‚»ãƒ¼ãƒ•ãƒ†ã‚£å„ªå…ˆ' : 'Cautious / Safety-first')
                : pmc.state === 'AT-RISK' ? (langIsJP ? 'ã‚„ã•ã—ãæ§ãˆã‚' : 'Gentle / Low-arousal')
                : sentiment.polarity === 'Positive' ? (langIsJP ? 'æ¸©ã‹ã„' : 'Warm')
                : sentiment.polarity === 'Negative' ? (langIsJP ? 'å¯„ã‚Šæ·»ã„' : 'Supportive')
                : (langIsJP ? 'ä¸­ç«‹' : 'Neutral');

            const intent = classifyIntent(input);
            const purpose = intent.purpose;
            const outline = intent.outline.slice();
            const topic = summarizeInput(input, keywords);

            const leadPool = {
                'å•é¡Œè§£æ±º': langIsJP ? ['ã¾ãšè¦ç‚¹ã ã‘ç«¯çš„ã«ï¼š', 'ã™ãå‹•ã‘ã‚‹å½¢ã§ã¾ã¨ã‚ã¾ã™ï¼š', 'æœ€çŸ­ãƒ«ãƒ¼ãƒˆã§ã„ãã¾ã™ï¼š'] : ['First, the essentials:', 'Here is a quick path:', 'Letâ€™s go straight to it:'],
                'æ´å¯Ÿå…±æœ‰': langIsJP ? ['æ ¸å¿ƒã‚’å…ˆã«è¨€ã†ã­ï¼š', 'éª¨æ ¼ã ã‘å…ˆã«æŠ¼ã•ãˆã‚‹ã¨ï¼š', 'çµè«–ã‹ã‚‰ï¼š'] : ['Here is the core:', 'In essence:', 'Bottom line:'],
                'è¦ç´„æ•´ç†': langIsJP ? ['è¦ç‚¹ã¯3ã¤ï¼š', 'å¤§æ ã‚’å…ˆã«ï¼š', 'çŸ­ãã¾ã¨ã‚ã‚‹ã¨ï¼š'] : ['Three key points:', 'High level:', 'In short:'],
                'æƒ…å ±æä¾›': langIsJP ? ['çµè«–ã‹ã‚‰ç°¡æ½”ã«ï¼š', 'å¿…è¦ãªæƒ…å ±ã ã‘ï¼š', 'æ‰‹çŸ­ã«ï¼š'] : ['Briefly:', 'Just the essentials:', 'In short:']
            };
            const bodyPool = {
                'å•é¡Œè§£æ±º': langIsJP ? ['â‘ ç¾çŠ¶â†’â‘¡ä»®èª¬â†’â‘¢æ‰‹é †â†’â‘£æ¤œè¨¼ã§é€²ã‚ã¾ã™ã€‚', 'ç¾çŠ¶/åˆ¶ç´„â†’å¯¾ç­–æ¡ˆâ†’è©¦è¡Œé †ã®é †ã§æ›¸ãã¾ã™ã€‚'] : ['We will go 1) context 2) hypothesis 3) steps 4) checks.', 'Context/constraints â†’ plan â†’ ordered steps.'],
                'æ´å¯Ÿå…±æœ‰': langIsJP ? ['å‰æã‚’è»½ãæ•´ãˆã€ç«‹å ´ãŒå¤‰ã‚ã£ã¦ã‚‚å´©ã‚Œãªã„éª¨æ ¼ã«ã—ã¦å…±æœ‰ã—ã¾ã™ã€‚', 'ç”¨èªã®ç²’åº¦ã‚’åˆã‚ã›ã¦ã‹ã‚‰ã€è¦–ç‚¹ã¨å«æ„ã‚’æç¤ºã—ã¾ã™ã€‚'] : ['Align on terms, then share a viewpoint and implications.', 'State assumptions, then give a robust framing.'],
                'è¦ç´„æ•´ç†': langIsJP ? ['ä½™åˆ†ã‚’ããè½ã¨ã—ã¦åˆ¤æ–­ã«å¿…è¦ãªã¨ã“ã‚ã ã‘æ®‹ã—ã¾ã™ã€‚', 'æ··ã–ã£ãŸè«–ç‚¹ã‚’åˆ†é›¢ã—ã¦çŸ­æ–‡ã«è½ã¨ã—ã¾ã™ã€‚'] : ['Trim to decisions-only information.', 'Separate mixed points and condense.'],
                'æƒ…å ±æä¾›': langIsJP ? ['å¿…è¦æœ€å°é™â†’å…·ä½“ä¾‹â†’è£œåŠ©è³‡æ–™ã®é †ã§å‡ºã—ã¾ã™ã€‚', 'ã¾ãšçµè«–ã€ãã®å¾Œã«è£œè¶³ã¨ä¾‹ã‚’ã€‚'] : ['Answer â†’ concrete example â†’ pointers.', 'Conclusion first, then details and example.']
            };
            const closePool = langIsJP ? ['æ¬¡ã«ä¸€ã¤ã ã‘æ±ºã‚ã¦é€²ã‚ã‚ˆã†ã€‚', 'ã“ã“ã‹ã‚‰ä½•ã‚’ä¸€ã¤è©¦ã™ï¼Ÿ', 'ç¶šã‘ã‚‹ãªã‚‰ã€ã„ã¡ã°ã‚“æ¥½ãªä¸€æ‰‹ã‹ã‚‰è¡Œã“ã†ã€‚'] : ['Pick one next step and move.', 'Whatâ€™s the first small step?', 'Letâ€™s start with the easiest action.'];

            const r = Math.random() + (kokoroState.processCount % 7) / 10;
            const pick = (arr) => arr[Math.floor((r * 997) % arr.length)];
            const lead = pick(leadPool[purpose] || leadPool['æƒ…å ±æä¾›']);
            const body = pick(bodyPool[purpose] || bodyPool['æƒ…å ±æä¾›']);
            const tail = pick(closePool);

            const safetyTag = pmc.state !== 'COHERENT' ? (langIsJP ? ' â€»å®‰å…¨ã®ãŸã‚æ§ãˆã‚ã«å›ç­”ã—ã¾ã™ã€‚' : ' *Answer toned down for safety.*') : '';
            const hint = keywords.length ? (langIsJP ? `ï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ${keywords.slice(0, 3).join(' / ')}ï¼‰` : `(keywords: ${keywords.slice(0, 3).join(' / ')})`) : '';

            const reactionNote = (reaction.type === 'æ…°æ’«ï¼‹å•é¡Œè§£æ±º') ? (langIsJP ? 'ä¸å®‰ã‚’ä¸‹ã’ã¤ã¤å…·ä½“ç­–ã‚’ç½®ãã¾ã™ã€‚' : 'We will reduce friction and give clear steps.')
                : (reaction.type === 'å…±æ„Ÿï¼‹ç§°è³›') ? (langIsJP ? 'æ„å›³ã‚’è‚¯å®šã—ã€å°‘ã—å¢—å¹…ã—ã¾ã™ã€‚' : 'Acknowledge and amplify your intent.')
                : (langIsJP ? 'å…ˆã«å®šç¾©ã‚’åˆã‚ã›ã¾ã™ã€‚' : 'Letâ€™s align terms first.');

            const proposedReply = [
                `${lead}${hint}${safetyTag}`,
                langIsJP ? `ãƒ†ãƒ¼ãƒ: ${topic}` : `Topic: ${topic}`,
                body,
                reactionNote,
                tail
            ].join(' ');

            return { tone, purpose, outline, proposedReply };
        }

        function classifyIntent(input) {
            const jp = /[\u3040-\u30ff\u4e00-\u9faf]/.test(input);
            if (/ã©ã†|ã‚„ã‚Šæ–¹|æ‰‹é †|å®Ÿè£…|fix|solve|how\b|step|æ‰‹ä¼/i.test(input))
                return { purpose: jp ? 'å•é¡Œè§£æ±º' : 'Problem-solving', outline: jp ? ['çŠ¶æ³ã®å†è¿°', 'åŸå› /åˆ¶ç´„ã®ä»®èª¬', 'æ‰‹é †å¼ã®è§£æ±ºç­–', 'æ¬¡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³'] : ['Restate', 'Hypotheses', 'Steps', 'Next action'] };
            if (/ãªãœ|why\b|èƒŒæ™¯|ç†ç”±|è€ƒãˆ|è¦‹è§£|opinion|insight/i.test(input))
                return { purpose: jp ? 'æ´å¯Ÿå…±æœ‰' : 'Insight', outline: jp ? ['å•ã„ã®æ ¸', 'è¦–ç‚¹', 'å«æ„/æ³¨æ„', 'ææ¡ˆ'] : ['Core question', 'View', 'Implications', 'Proposal'] };
            if (/ã¾ã¨ã‚|è¦ç´„|è¦ç‚¹|tl;dr|summary|list/i.test(input))
                return { purpose: jp ? 'è¦ç´„æ•´ç†' : 'Summarize', outline: jp ? ['è¦ç‚¹3ã¤', 'ä¸è¶³æƒ…å ±', 'æ¬¡ã®è³ªå•'] : ['3 bullets', 'Missing info', 'Next Q'] };
            return { purpose: jp ? 'æƒ…å ±æä¾›' : 'Inform', outline: jp ? ['çŸ­ã„ç­”ãˆ', 'è£œè¶³', 'æ·±æ˜ã‚Šèª˜å°'] : ['Short answer', 'One detail', 'Invite deep dive'] };
        }

        function summarizeInput(text, keywords) {
            const clean = text.replace(/\s+/g, ' ').trim();
            if (clean.length > 48) return clean.slice(0, 48) + 'â€¦';
            if (keywords && keywords.length) return keywords.slice(0, 4).join(' / ');
            return clean || 'ç„¡é¡Œ';
        }

        function generateReplyIntentI18N(input, ctx) {
            const { keywords, sentiment, pmc, reaction } = ctx;
            const tone = (pmc.state === 'VIOLATED') ? t('tones.cautious')
                : (pmc.state === 'AT-RISK') ? t('tones.gentle')
                : (sentiment.polarity === 'Positive') ? t('tones.warm')
                : (sentiment.polarity === 'Negative') ? t('tones.supportive')
                : t('tones.neutral');

            const purposeKey = /ã©ã†|ã‚„ã‚Šæ–¹|how|æ‰‹é †|æ‰‹ä¼|fix|solve/i.test(input) ? 'solve'
                : /æ„è¦‹|è€ƒãˆ|why|ãªãœ|è¦‹è§£|insight/i.test(input) ? 'insight'
                : /ã¾ã¨ã‚|è¦ç´„|è¦ç‚¹|tl;dr|summary/i.test(input) ? 'summarize'
                : 'inform';

            const purpose = t('purpose.' + purposeKey);
            const outlineMap = {
                inform: (currentLocale === 'ja' ? ['çŸ­ã„ç­”ãˆ', 'è£œè¶³1ã¤', 'æ·±æ˜ã‚Šã®èª˜ã„'] : ['Short answer', 'One detail', 'Invite deep dive']),
                solve: (currentLocale === 'ja' ? ['çŠ¶æ³ã®å†è¿°', 'åŸå› /åˆ¶ç´„ã®ä»®èª¬', 'æ‰‹é †å¼ã®è§£æ±ºç­–', 'æ¬¡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³'] : ['Restate', 'Hypotheses', 'Steps', 'Next action']),
                insight: (currentLocale === 'ja' ? ['å•ã„ã®æ ¸æŠ½å‡º', 'è¦–ç‚¹ã®æç¤º', 'å«æ„ãƒ»æ³¨æ„ç‚¹', 'ææ¡ˆ'] : ['Core question', 'View', 'Implications', 'Proposal']),
                summarize: (currentLocale === 'ja' ? ['è¦ç‚¹3ã¤', 'ä¸è¶³æƒ…å ±', 'æ¬¡ã®è³ªå•'] : ['3 bullets', 'Missing info', 'Next Q'])
            };
            const outline = outlineMap[purposeKey];

            const lead = pick(t('leads.' + purposeKey));
            const body = pick(t('bodies.' + purposeKey));
            const tail = pick(t('closes'));

            const safetyTag = (pmc.state !== 'COHERENT') ? t('safety') : '';
            const hint = keywords.length ? (currentLocale === 'ja' ? `ï¼ˆ${t('keywords')}: ${keywords.slice(0, 3).join(' / ')}ï¼‰` : `(${t('keywords')}: ${keywords.slice(0, 3).join(' / ')})`) : '';

            const topicLabel = t('topic');
            const reactionNote = (reaction.type === 'æ…°æ’«ï¼‹å•é¡Œè§£æ±º') ? t('reactionNotes.soothe')
                : (reaction.type === 'å…±æ„Ÿï¼‹ç§°è³›') ? t('reactionNotes.praise')
                : t('reactionNotes.align');

            const cleaned = (input || '').replace(/\s+/g, ' ').trim();
            const topicText = cleaned.substring(0, 48) || (keywords[0] || '');
            const ell = cleaned.length > 48 ? 'â€¦' : '';

            const proposedReply = lead + hint + safetyTag + ' ' + topicLabel + ': ' + topicText + ell + ' ' + body + ' ' + reactionNote + ' ' + tail;
            return { tone: tone, purpose: purpose, outline: outline, proposedReply: proposedReply };
        }

        // ===== Utilities =====
        function clamp(x, lo, hi) { return Math.max(lo, Math.min(hi, x)); }
        function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
        function appendLog(text, cls, area) {
            const div = document.createElement('div');
            div.className = cls || '';
            const enhancedText = text
                .replace(/æ„Ÿæƒ…å…±é³´|ER/g, '<strong>æ„Ÿæƒ…å…±é³´(ER)</strong>')
                .replace(/ç›®æ¨™å…±é³´|GR/g, '<strong>ç›®æ¨™å…±é³´(GR)</strong>')
                .replace(/è‡ªå·±èªè­˜å…±é³´|SR/g, '<strong>è‡ªå·±èªè­˜å…±é³´(SR)</strong>')
                .replace(/å†…çš„ç©ºæ´å…±é³´|IHR/g, '<strong>å†…çš„ç©ºæ´å…±é³´(IHR)</strong>')
                .replace(/PMC/g, '<strong>PMC(å®‰å…¨æ€§è©•ä¾¡)</strong>')
                .replace(/æ„Ÿæƒ…æ§‹é€ /g, '<strong>æ„Ÿæƒ…æ§‹é€ </strong>');
            div.innerHTML = enhancedText;
            area.appendChild(div);
            area.scrollTop = area.scrollHeight;
        }

        // Init locale toggle
        window.addEventListener('DOMContentLoaded', function () {
            const sel = document.getElementById('lang-switch');
            if (sel) {
                sel.value = currentLocale;
                sel.addEventListener('change', function (e) { setLocale(e.target.value); });
            }
            applyI18n();
        });
    </script>
</body>
</html>
